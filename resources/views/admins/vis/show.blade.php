@extends('layouts.admin')

@section('title', 'L·ªãch s·ª≠ v√≠ ng∆∞·ªùi d√πng')

@section('content')
    @if ($errors->any())
        <div class="alert alert-danger">
            {{ $errors->first() }}
        </div>
    @endif
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 style="color: #009688; font-weight: 700;">L·ªãch s·ª≠ v√≠ -
                <span class="text-dark">{{  $user->username }}</span>
            </h4>
            <span class="badge rounded-pill px-3 py-2 fs-6" style="background-color: #009688; color: white;">
                üí∞ S·ªë d∆∞: {{ number_format($user->vi->so_du ?? 0, 0, ',', '.') }} VNƒê
            </span>

        </div>

        {{-- B·ªô l·ªçc tr·∫°ng th√°i --}}
        <div class="card shadow mb-4 rounded-4">
            <div class="card-body">
                <form method="GET" class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-3 align-items-end">
                    {{-- Tr·∫°ng th√°i --}}
                    <div>
                        <label for="trang_thai" class="form-label fw-semibold">Tr·∫°ng th√°i</label>
                        <select name="trang_thai" id="trang_thai" class="form-select" onchange="this.form.submit()">
                            <option value="">T·∫•t c·∫£</option>
                            <option value="1" {{ request('trang_thai') === '1' ? 'selected' : '' }}>‚úÖ Th√†nh c√¥ng</option>
                            <option value="0" {{ request('trang_thai') === '0' ? 'selected' : '' }}>‚è≥ Ch·ªù x·ª≠ l√Ω</option>
                            <option value="2" {{ request('trang_thai') === '2' ? 'selected' : '' }}>‚ùå Hu·ª∑</option>
                        </select>
                    </div>

                    {{-- Lo·∫°i giao d·ªãch --}}
                    <div>
                        <label for="loai" class="form-label fw-semibold">Lo·∫°i giao d·ªãch</label>
                        <select name="loai" id="loai" class="form-select" onchange="this.form.submit()">
                            <option value="">T·∫•t c·∫£</option>
                            <option value="N·∫°p ti·ªÅn" {{ request('loai') === 'N·∫°p ti·ªÅn' ? 'selected' : '' }}>üí∞ N·∫°p ti·ªÅn
                            </option>
                            <option value="R√∫t ti·ªÅn" {{ request('loai') === 'R√∫t ti·ªÅn' ? 'selected' : '' }}>üèß R√∫t ti·ªÅn
                            </option>
                            <option value="Ho√†n ti·ªÅn" {{ request('loai') === 'Ho√†n ti·ªÅn' ? 'selected' : '' }}>‚Ü©Ô∏è Ho√†n ti·ªÅn
                            </option>
                            <option value="Mua h√†ng" {{ request('loai') === 'Mua h√†ng' ? 'selected' : '' }}>üõí Mua h√†ng
                            </option>
                        </select>
                    </div>

                    {{-- T·ª´ ng√†y --}}
                    <div>
                        <label for="tu_ngay" class="form-label fw-semibold">T·ª´ ng√†y</label>
                        <input type="date" name="tu_ngay" id="tu_ngay" class="form-control" value="{{ request('tu_ngay') }}"
                            onchange="this.form.submit()">
                    </div>

                    {{-- ƒê·∫øn ng√†y --}}
                    <div>
                        <label for="den_ngay" class="form-label fw-semibold">ƒê·∫øn ng√†y</label>
                        <input type="date" name="den_ngay" id="den_ngay" class="form-control"
                            value="{{ request('den_ngay') }}" onchange="this.form.submit()">
                    </div>
                </form>
            </div>
        </div>




        {{-- C·∫≠p nh·∫≠t tr·∫°ng th√°i --}}
        <form method="POST" id="form-cap-nhat-trang-thai" action="{{ route('admin.vis.updateTrangThai') }}" onsubmit="return handleCapNhat(event)">
            @csrf
            <div class="card shadow mb-4" style="border-radius: 16px;">
                <div class="card-body">
                    <div class="row g-3 align-items-center">
                        <!-- Select tr·∫°ng th√°i -->
                        <div class="col-auto">
                            <label for="trang_thai_moi" class="form-label mb-0 fw-semibold">Tr·∫°ng th√°i m·ªõi</label>
                            <select name="trang_thai" id="trang_thai_moi"
                                class="form-select form-select-sm border-0 rounded-3 shadow-sm" style="min-width: 180px;"
                                required onchange="toggleLyDo()">
                                <option value="">-- Ch·ªçn tr·∫°ng th√°i --</option>
                                <option value="1">‚úÖ Duy·ªát y√™u c·∫ßu</option>
                                <option value="2">‚ùå Hu·ª∑ y√™u c·∫ßu</option>
                            </select>
                        </div>

                        <!-- Input l√Ω do (·∫©n/hi·ªán) -->
                        <div class="col-auto d-none" id="ly_do_wrapper">
                            <label for="ly_do_chung" class="form-label mb-0 fw-semibold">L√Ω do hu·ª∑</label>
                            <input type="text" name="ly_do" id="ly_do_chung"
                                class="form-control form-control-sm border-0 rounded-3 shadow-sm"
                                placeholder="Nh·∫≠p l√Ω do hu·ª∑..." style="min-width:800px; max-width: 100%;">
                        </div>


                        <!-- N√∫t c·∫≠p nh·∫≠t -->
                        <div class="col-auto d-flex align-items-end">
                            <button type="submit" class="btn btn-sm"
                                style="background-color: #009688; color: white; border-radius: 20px; padding: 8px 20px;"
                                onclick="return handleCapNhat()">
                                <i class="bi bi-check-circle me-1"></i> C·∫≠p nh·∫≠t
                            </button>
                        </div>
                    </div>
                </div>
            </div>




            {{-- B·∫£ng giao d·ªãch --}}
            <div class="table-responsive">
                <table class="table table-bordered table-hover align-middle">
                    <thead style="background-color: #009688 !important;">
                        <tr>
                            <th style="color: white;"><input type="checkbox" id="checkAll"></th>
                            <th style="color: white;">M√£ giao d·ªãch</th>
                            <th style="color: white;">S·ªë ti·ªÅn</th>
                            <th style="color: white;">Lo·∫°i</th>
                            <th style="color: white;">M√¥ t·∫£</th>
                            <th style="color: white;">Tr·∫°ng th√°i</th>
                            <th style="color: white;">Th·ªùi gian</th>
                        </tr>
                    </thead>

                    <tbody>
                        @if (!$user->vi)
                            <tr>
                                <td colspan="6" class="text-center text-danger">Ng∆∞·ªùi d√πng ch∆∞a c√≥ v√≠</td>
                            </tr>
                        @else
                            @forelse ($giaodichs as $gd)
                                <tr>

                                    <td><input type="checkbox" name="ids[]" value="{{ $gd->id }}"></td>
                                    <td class="text-center">{{ $gd->ma_giao_dich }}</td>
                                    <td>
                                        @if(in_array($gd->loai, ['R√∫t ti·ªÅn', 'Mua h√†ng', 'Thanh to√°n']))
                                            @if($gd->trang_thai == 1)
                                                <span class="text-danger">-{{ number_format(abs($gd->so_tien), 0, ',', '.') }} VNƒê</span>
                                            @else
                                                <span class="text-warning">{{ number_format(abs($gd->so_tien), 0, ',', '.') }} VNƒê</span>
                                            @endif
                                        @elseif(in_array($gd->loai, ['N·∫°p ti·ªÅn', 'Ho√†n ti·ªÅn']))
                                            @if($gd->trang_thai == 2)
                                                <span class="text-warning">{{ number_format($gd->so_tien, 0, ',', '.') }} VNƒê</span>
                                            @else
                                                <span class="text-success">+{{ number_format($gd->so_tien, 0, ',', '.') }} VNƒê</span>
                                            @endif
                                        @else
                                            <span class="text-dark">{{ number_format($gd->so_tien, 0, ',', '.') }} VNƒê</span>
                                        @endif
                                    </td>

                                    <td>
                                        <span class="badge bg-light border border-1 text-dark px-2">{{ $gd->loai }}</span>
                                    </td>
                                    <td>
                                        {!! nl2br(e($gd->mo_ta)) !!}

                                        @if ($gd->trang_thai == 1 && $gd->updated_at)
                                            <br>
                                            <strong class="text-muted">
                                                Th·ªùi gian x·ª≠ l√Ω üïí {{ $gd->updated_at->format('d/m/Y H:i') }}
                                            </strong>
                                        @endif
                                    </td>

                                    <td class="text-center">
                                        @if($gd->trang_thai == 1)
                                            <span
                                                style="background-color: #28a745; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.85rem;">
                                                ‚úî Th√†nh c√¥ng
                                            </span>
                                        @elseif($gd->trang_thai == 0)
                                            <div class="d-flex flex-column align-items-center gap-1">
                                                <span
                                                    style="background-color: #ffc107; color: black; padding: 2px 6px; border-radius: 4px; font-size: 0.85rem;">
                                                    ‚è≥ Ch·ªù x·ª≠ l√Ω
                                                </span>
                                                <div class="d-flex gap-1">
                                                    {{-- N√∫t duy·ªát --}}

                                                    <a href="#" onclick="duyetLe({{ $gd->id }}, '{{ $gd->ma_giao_dich }}')"
                                                        class="btn btn-success btn-sm">‚úÖ</a>

                                                    {{-- <form id="form-duyet-{{ $gd->id }}"
                                                        action="{{ route('admin.vis.updateTrangThaiTungGiaoDich', ['id' => $gd->id]) }}"
                                                        method="POST" style="display: none;">
                                                        @csrf
                                                        <input type="hidden" name="id" value="{{ $gd->id }}">
                                                        <input type="hidden" name="trang_thai" value="1">
                                                    </form> --}}



                                                    {{-- N√∫t hu·ª∑ m·ªü modal --}}
                                                    <button type="button" class="btn btn-danger btn-sm px-2 py-1" data-bs-toggle="modal"
                                                        data-bs-target="#huyModal" data-id="{{ $gd->id }}">
                                                        ‚ùå
                                                    </button>


                                                </div>
                                            </div>
                                        @elseif($gd->trang_thai == 2)
                                            <span
                                                style="background-color: #dc3545; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.85rem;">
                                                ‚ùå ƒê√£ hu·ª∑
                                            </span>
                                        @endif
                                    </td>



                                    <td>{{ $gd->created_at->format('d/m/Y H:i') }}</td>
                                </tr>
                            @empty
                                <tr>
                                    <td colspan="6" class="text-center text-muted">Kh√¥ng c√≥ giao d·ªãch n√†o</td>
                                </tr>

                            @endforelse
                        @endif
                    </tbody>
                </table>
            </div>

            {{-- Ph√¢n trang --}}
            <div class="d-flex justify-content-center mt-3">
                {{ $giaodichs->appends(request()->query())->links('pagination::bootstrap-5') }}
            </div>
        </form>
        <!-- Modal hu·ª∑ t·ª´ng giao d·ªãch -->
        <!-- Modal hu·ª∑ -->
        <div class="modal fade" id="huyModal" tabindex="-1" aria-labelledby="huyModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <form method="POST" id="huyForm" {{--
                    action="{{ route('admin.vis.updateTrangThaiTungGiaoDich', ['id' => $gd->id]) }}" --}}>
                    @csrf
                    <input type="hidden" name="id" id="modal_gd_id">
                    <input type="hidden" name="trang_thai" value="2">
                    <div class="modal-content">
                        <div class="modal-header bg-danger text-white">
                            <h5 class="modal-title" id="huyModalLabel">Hu·ª∑ giao d·ªãch</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                                aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <label for="modal_ly_do" class="form-label">L√Ω do hu·ª∑:</label>
                            <textarea name="ly_do" id="modal_ly_do" rows="3" class="form-control" required></textarea>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                            <button type="submit" class="btn btn-danger">X√°c nh·∫≠n hu·ª∑</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>







@endsection
@section('js')

    {{--
    <script>
        function duyetLe(id, ma_giao_dich) {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën duy·ªát giao d·ªãch m√£ #' + ma_giao_dich + '?')) {
                document.getElementById('form-duyet-' + id).submit();
            }
        }
    </script> --}}
    <script>
        function duyetLe(id, ma_giao_dich) {
            Swal.fire({
                title: `X√°c nh·∫≠n duy·ªát giao d·ªãch`,
                text: `B·∫°n c√≥ ch·∫Øc mu·ªën duy·ªát giao d·ªãch ${ma_giao_dich}?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: '‚úî Duy·ªát',
                cancelButtonText: 'Hu·ª∑',
                confirmButtonColor: '#009688',
                cancelButtonColor: '#dc3545'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/vi/cap-nhat-tung-giao-dich/${id}`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRF-TOKEN": "{{ csrf_token() }}"
                        },
                        body: JSON.stringify({
                            id: id,
                            trang_thai: 1
                        })
                    })
                        .then(res => res.json())
                        .then(data => {
                            if (data.status === 'success') {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Th√†nh c√¥ng!',
                                    text: data.message,
                                    confirmButtonColor: '#009688'
                                }).then(() => location.reload());
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'L·ªói!',
                                    text: data.message
                                }).then(() => location.reload());
                            }
                        });
                }
            });
        }

    </script>




    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Khi modal m·ªü, g√°n ID v√†o input ·∫©n
            const huyModal = document.getElementById('huyModal');
            if (huyModal) {
                huyModal.addEventListener('show.bs.modal', function (event) {
                    const button = event.relatedTarget;
                    const giaoDichId = button.getAttribute('data-id');
                    document.getElementById('modal_gd_id').value = giaoDichId;
                });
            }

            // B·∫Øt s·ª± ki·ªán submit form hu·ª∑
            const huyForm = document.getElementById('huyForm');
            if (huyForm) {
                huyForm.addEventListener('submit', function (e) {
                    e.preventDefault();

                    const id = document.getElementById('modal_gd_id').value;
                    const ly_do = document.getElementById('modal_ly_do').value;

                    fetch(`/vi/cap-nhat-tung-giao-dich/${id}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-TOKEN': '{{ csrf_token() }}'
                        },
                        body: JSON.stringify({
                            id: id,
                            trang_thai: 2,
                            ly_do: ly_do
                        })
                    })
                        .then(async res => {
                            const data = await res.json().catch(() => ({})); // tr√°nh l·ªói khi kh√¥ng ph·∫£i JSON
                            if (res.ok && data.success === 'success') {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Hu·ª∑ th√†nh c√¥ng!',
                                    text: data.message,
                                    confirmButtonColor: '#009688'
                                }).then(() => location.reload());
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'L·ªói!',
                                    text: data.message || 'ƒê√£ x·∫£y ra l·ªói.'
                                }).then(() => location.reload()); // ‚ö†Ô∏è Reload trang ngay c·∫£ khi l·ªói
                            }
                        })
                        .catch(() => {
                            Swal.fire({
                                icon: 'error',
                                title: 'L·ªói!',
                                text: 'Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi m√°y ch·ªß.'
                            });
                        });

                });
            }
        });
    </script>



    {{-- Check All --}}
    <script>
        document.getElementById('checkAll').addEventListener('click', function () {
            document.querySelectorAll('input[name="ids[]"]').forEach(el => el.checked = this.checked);
        });
    </script>

    <script>
        function toggleLyDo() {
            const trangThai = document.getElementById('trang_thai_moi').value;
            const lyDoWrapper = document.getElementById('ly_do_wrapper');
            const lyDoInput = document.getElementById('ly_do_chung');

            if (trangThai == '2') {
                lyDoWrapper.classList.remove('d-none');
                lyDoInput.setAttribute('required', 'required');
            } else {
                lyDoWrapper.classList.add('d-none');
                lyDoInput.removeAttribute('required');
            }
        }

        function handleCapNhat(e) {
        const trangThai = document.getElementById('trang_thai_moi').value;

        if (trangThai === "1") {
            e.preventDefault(); // NgƒÉn form g·ª≠i ƒëi

            Swal.fire({
                title: 'X√°c nh·∫≠n duy·ªát y√™u c·∫ßu',
                text: 'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën duy·ªát y√™u c·∫ßu n√†y?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: '‚úî Duy·ªát',
                cancelButtonText: 'Hu·ª∑',
                confirmButtonColor: '#009688',
                cancelButtonColor: '#dc3545'
            }).then((result) => {
                if (result.isConfirmed) {
                    document.getElementById('form-cap-nhat-trang-thai').submit(); // Submit l·∫°i form th·ªß c√¥ng
                }
            });

            return false; // Kh√¥ng cho submit ngay l·∫≠p t·ª©c
        }

        return true; // N·∫øu tr·∫°ng th√°i kh√°c, cho submit b√¨nh th∆∞·ªùng
    }



        document.getElementById('checkAll')?.addEventListener('click', function () {
            const checkboxes = document.querySelectorAll('input.trang_thai_gd');
            checkboxes.forEach(cb => cb.checked = this.checked);
        });

        document.querySelector('form-cap-nhat-trang-thai').addEventListener('submit', function (e) {
            const selected = document.querySelectorAll('input.trang_thai_gd:checked');
            if (selected.length === 0) {
                alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt giao d·ªãch.');
                e.preventDefault();
                return;
            }

            const trangThaiMoi = document.getElementById('trang_thai_moi').value;
            if (!trangThaiMoi) {
                alert('Vui l√≤ng ch·ªçn tr·∫°ng th√°i m·ªõi.');
                e.preventDefault();
                return;
            }

            let valid = true;
            selected.forEach(cb => {
                if (cb.dataset.trangThai !== '0') {
                    valid = false;
                }
            });

            if (!valid) {
                alert('Ch·ªâ ƒë∆∞·ª£c c·∫≠p nh·∫≠t c√°c giao d·ªãch ƒëang ·ªü tr·∫°ng th√°i ch·ªù x√°c nh·∫≠n.');
                e.preventDefault();
            }
        });

        document.addEventListener('DOMContentLoaded', toggleLyDo);
    </script>





    </script>
    <!-- customizer js -->
    <script src="{{ asset('assets/js/customizer.js') }}"></script>

    <!-- Sidebar js -->
    <script src="{{ asset('assets/js/config.js') }}"></script>

    <!-- Plugins JS -->
    <script src="{{ asset('assets/js/sidebar-menu.js') }}"></script>

    <!-- Data table js -->
    <script src="{{ asset('assets/js/jquery.dataTables.js') }}"></script>
    <script src="{{ asset('assets/js/custom-data-table.js') }}"></script>

    <script src="{{ asset('assets/js/checkbox-all-check.js') }}"></script>
@endsection